import pandas as pd
import sqlalchemy
from sqlalchemy.sql import select
from sqlalchemy import MetaData
from widgetslib.datasupport import *

class DataAPI():
    
    def __init__(self):
        
        self.conn = sqlalchemy.create_engine("sqlite:///data/webscan.db")
        self.meta = MetaData(self.conn,reflect=True)

        
    def return_table(self, table_name):
        
        if table_name not in self.conn.table_names():
            return "Wrong tablename"
        else:
            return pd.read_sql_table(table_name, self.conn)
        
    def return_domain_list(self):
        
        return pd.read_sql_table("subdomain", self.conn)['domain'].values
    
    def return_ip_list(self):
        
        return pd.read_sql_table("subdomain", self.conn)['ip4_1'].values
    
    
    def return_portscan(self, ip):
        
        
        portscan = self.meta.tables['portscan']
        s = select([portscan]).where(portscan.c.ip == ip)
        result = pd.read_sql(s, self.conn)
        
        if result.shape[0] > 1:
            return extract_scan(result.iloc[0])
        
        elif result.shape[0] == 0:
            return "noportscan"
        
        else:
            return extract_scan(result)
        
    def ip_to_domain(self, ip):
        
        df = dbapi.return_table("subdomain")
        
        if not df.empty:
            return df.query("ip4_1==@ip")["domain"].values
        else:
            return ""

    def domain_to_ip(self, domain):
        
        df = dbapi.return_table("subdomain")
        
        if not df.empty:
            return df.query("domain==@domain")["ip4_1"].values
        else:
            return ""
